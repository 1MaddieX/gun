<!DOCTYPE html>
<html>
<head>
<!-- always start with these two lines to set a clean baseline for different devices -->
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" type="text/css" href="style.css">
<script src="jquery.js"></script>

<title>Docs</title>
</head>
<body class="black whitet">
<style>
	/*
		Choose white text on a black background so you can add color in.
		Pick your favorite font and choose a font size.
	*/
	@import url('https://fonts.googleapis.com/css?family=Oxygen');
	html, body {
		font-family: "Oxygen", sans-serif;
	}

	[contenteditable]:focus {
		outline: none;
	}
</style>

<div class="hold full hue2">
	<div id="page" class="max focus gap" style="padding-top: 9%;"></div>
</div>
<script src="../../gun/gun.js"></script>
<script src="../../gun/lib/monotype.js"></script>
<script src="../../gun/lib/meta.js"></script>
<script src="../../gun/lib/normalize.js"></script>
<script async src="../../gun/lib/fun.js"></script>
<script>
var gun = Gun('https://guntest.herokuapp.com/gun');

;(window.onhashchange = function(){
	var file = (location.hash||'').slice(1);
	var S = +new Date;
	gun.get('test/gun/docs/'+file).get('what').map().on(function render(data, i){
		if(window.LOCK){ return }
		var p = $('#page').children().get(i);
		if(!p){
			$('#page').append('<p>');
			setTimeout(function(){ render(data, i) },0);
			return;
		}
		var r = monotype(p);
		var safe = $.normalize(data);
		p.outerHTML = safe;
		r.restore();
	});
})();

document.execCommand('defaultParagraphSeparator', false, 'p');
meta.edit({
	name: "Edit",
	combo: ['E'],
	use: function(eve){
		console.log('on');
	}, on: function(eve){
		var edit = this;
		setTimeout(function(){ meta.flip(false) },1);
		var doc = $('#page').attr('contenteditable', 'true');
		if(!doc.text()){
			doc.html('<p class="loud crack"></p>');
		}
		edit.select(doc.children().first().get(0));
		$(document).on('keydown.tmp', '[contenteditable]', function(eve){
			if(eve.which != 13){ return }
			eve.preventDefault();
			var r = window.getSelection().getRangeAt(0);
			var c = r.commonAncestorContainer;
      r.deleteContents();
      c.splitText(r.startOffset);
      var p = $(c).parent(), n = $("<"+p.get(0).tagName+">"), f;
      p.contents().each(function(){
      	if(this === c){ return f = true }
      	if(!f){ return }
      	n.append(this);
      });
      p.after(n);
      edit.select(n.get(0));
      // make sure we re-save & sync each changed paragraph.
      edit.save(p);
      p.nextAll().each(function(){
      	edit.save(this);
      });
		}).on('keyup.tmp', '[contenteditable]', function(eve){
			$('#debug').val(doc.html());
			var p = $(window.getSelection().anchorNode).closest('p');
			var r = monotype(p);
			var html = p.html() || '';
			var safe = $.normalize(html);
			p.html(safe);
			r.restore();
			edit.save(p);
		});
	},
	up: function(){
		console.log("UP");
		$('[contenteditable=true]').off('.tmp');
	},
	save: function(p){
		p = $(p);
		var i = p.index();// = Array.prototype.indexOf.call(parent.children, child);
		var file = (location.hash||'').slice(1);
		var data = p.get(0).outerHTML;
		window.LOCK = true;
		gun.get('test/gun/docs/'+file).get('what').get(i).put(data);
		window.LOCK = false;
	},
	select: function(p){
		var s = window.getSelection(),
		r = document.createRange();
		if(p.innerHTML){
      r.setStart(p, 0);
			r.collapse(true);
			s.removeAllRanges();
			s.addRange(r);
			return;
		}
		p.innerHTML = '\u00a0';
		r.selectNodeContents(p);
		s.removeAllRanges();
		s.addRange(r);
		document.execCommand('delete', false, null);
	}
});

;(function(){

	meta.edit({name: "Layout", combo: ['E','L']});

	meta.edit({name: "Fill", combo: ['E','L','F'],
		use: function(eve){},
		on: function(eve){
			var on = meta.tap();
			meta.ask('Color name, code, or URL?', function(color){
				on.css('background', color);
			});
		},
		up: function(eve){}
	});

	meta.edit({name: "Add", combo: ['E','L','A']});
	meta.edit({name: "Row", combo: ['E','L','A', 'R'],
    on: function(eve){
			meta.tap().append('<div style="min-height: 9em; padding: 2%;">');
    }
	});
	meta.edit({name: "Columns", combo: ['E','L','A','C'],
    on: function(eve){
			var on = meta.tap().addClass('center'), tmp, c;
			var html = '<div class="unit col" style="min-height: 9em; padding: 2%;"></div>';
			if(!on.children('.col').length){ html += html }
			c = (tmp = on.append(html).children('.col')).length;
			tmp.each(function(){
	    	$(this).css('width', (100/c)+'%');
			})
    }
	});
	meta.edit({name: "Text", combo: ['A','T'],
    on: function(eve){
    	var tag = $('<p>text</p>');
			meta.tap().append(tag);
			tag.focus();
    }
	});

}());
</script>
</body>
</html>